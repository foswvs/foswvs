<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<title>device information</title>
<link href="/css/normalize.css" rel="stylesheet">
<link href="/css/skeleton.css" rel="stylesheet">
<link href="/css/a.css" rel="stylesheet">
<style>tr:hover{cursor:default !important;background:none !important;}.paddless{padding:0;}</style>
</head>
<body>
<div class="container" style="margin-top:10px;">
  <div class="row" id="xmenubar"> </div>
  <div class="row">
    <div class="six columns" style="border:1px solid #ccc;border-radius:4px; padding: 20px; margin-top:10px;">
      <h5>Add Data</h5>
      <hr>
      <label>Data Size In MB <span id="label_format_mb" style="font-size:10px;font-weight:400;">&nbsp;</span></label>  
      <input class="u-full-width" id="mb_input" type="text" placeholder="1024">
      <button class="button" id="mb_btn" type="button" onsubmit="return false;">Add</button>
    </div>

    <div class="six columns" style="border:1px solid #ccc;border-radius:4px; padding: 20px; margin-top: 10px;">
      <h5>Device Information</h5>
      <hr>
      <div class="row table-wrap">
        <table class="u-full-width">
          <tr><th>IP Address</th><th class="paddless">:</th><td id="ip_addr">Identifying</td></tr>
          <tr><th>MAC Address</th><th class="paddless">:</th><td id="mac_addr">Identifying</td></tr>
          <tr><th>Hostname</th><th class="paddless">:</th><td id="hostname">Identifying</td></tr>
          <tr><th>Total MB Free</th><th class="paddless">:</th><td id="mb_free">Calculating</td></tr>
          <tr><th>Total MB Used</th><th class="paddless">:</th><td id="mb_used">Calculating</td></tr>
          <tr><th>Total MB Limit</th><th class="paddless">:</th><td><span id="mb_limit">Calculating</span> <button class="button" id="mb_reset">reset</button></td></tr>
          <tr><th>Last Active</th><th class="paddless">:</th><td id="last_active">...</td></tr>
        </table>
      </div>
    </div>
  </div>
  <hr>
  <div class="row table-wrap">
    <table class="u-full-width" id="tx_table">
      <thead>
        <tr><th>Date</th><th>Total</th><th>Amt</th><th>Data</th><th>Used</th></tr>
      </thead>
   </table>
   <a class="button" href="#" id="tx_count">0 tx</a>
  </div>
</div>
<script src="/js/a.js"></script>
<script>
const mac = search.substr(5),
  ip_addr = document.getElementById('ip_addr'),
  mac_addr = document.getElementById('mac_addr'),
  hostname = document.getElementById('hostname'),
  mb_input = document.getElementById('mb_input'),
  mb_reset = document.getElementById('mb_reset'),
  mb_free  = document.getElementById('mb_free'),
  mb_used  = document.getElementById('mb_used'),
  mb_limit = document.getElementById('mb_limit'),
  activets = document.getElementById('last_active');

var subtotal = 0, tx_count=0, table = document.getElementById('tx_table'), tbody = document.createElement('tbody');

table.appendChild(tbody);

function tx_table(tx) {
  subtotal = subtotal + tx.amt;

  let row = tbody.insertRow(-1),
   col_ts = row.insertCell(0),
   col_tt = row.insertCell(1),
  col_amt = row.insertCell(2),
  col_mb1 = row.insertCell(3),
  col_mb2 = row.insertCell(4),
  txt_amt = document.createTextNode(tx.amt==0 ? 'FREE' : peso.format(tx.amt)),
  txt_mb1 = document.createTextNode(format_mb(tx.mb_limit)),
  txt_mb2 = document.createTextNode(format_mb(tx.mb_used)),
   txt_ts = document.createTextNode(new Date(tx.ts).toLocaleString()),
   txt_tt = document.createTextNode(peso.format(subtotal));

  col_amt.appendChild(txt_amt);
  col_mb1.appendChild(txt_mb1);
  col_mb2.appendChild(txt_mb2);
   col_ts.appendChild(txt_ts);
   col_tt.appendChild(txt_tt);

  document.getElementById('tx_count').innerText=`${++tx_count} transactions`;
}

function tx_table_blank(){
  let row = tbody.insertRow(-1),
    blank = row.insertCell(0);

  blank.setAttribute('colspan', 5);
  blank.style.textAlign = 'center';
  blank.appendChild(document.createTextNode('No Transaction History'));
}

function device_info() {
  fetch('/a/x.php?dev=get_session&mac='+mac)
    .then((x) => {return x.ok ? x.json() : window.location.assign('/a')})
    .then((x) => {
      mac_addr.innerText = x.mac;
      ip_addr.innerHTML  = `${x.ip}  ${x.connected ? '<span style="color:green;">&#x2713</span>' : '<span style="color:red;">&#x2717</span>'}`;
      hostname.innerText = x.host;
      activets.innerText = x.last_active ? utc_to_local(x.last_active) : '-NA-';

      mb_free.innerText  = format_mb(x.mb_limit-x.mb_used);
      mb_used.innerText  = format_mb(x.mb_used);
      mb_limit.innerText = format_mb(x.mb_limit);

      mb_reset.setAttribute('data-mac', x.mac);

      if(!x.mb_limit) mb_reset.style.display='none';

      setTimeout(get_tx,200);
    }
  );
}

function mb_add(limit) {
  fetch(`/a/x.php?dev=add_session&mac=${mac}&limit=${limit}`)
    .then((x) => x.json())
    .then((x) => {
      setTimeout(device_info,300);
    }
  );
}

function get_tx() {
  empty_table('tx_table'); subtotal=0; tx_count=0;
  fetch('./x.php?dev=get_txn&mac='+mac).then((x) => x.json()).then((x) => {
    x.forEach((tx) => {
      tx.ts ? tx_table(tx) : tx_table_blank();
    });
  });
}

mb_input.addEventListener('keyup', (e) => {
  let mb = parseInt(mb_input.value);

  document.getElementById('label_format_mb').innerText='='+format_mb(mb);

  if(e.keyCode != 13 || mb < 1) return;

  mb_add(mb);

  mb_input.value = '';
});

document.getElementById('mb_btn').addEventListener('click', (e) => {
  let mb = parseInt(mb_input.value);

  if( mb < 1 ) return false;

  mb_add(mb);

  mb_input.value = '';
});

mb_reset.addEventListener('click', (e) => {
  if(confirm("Select OK to confirm reset mb limit.\nThis will clear device transactions.")) {
    fetch('/a/x.php?dev=clear_mb&mac=' + e.target.dataset.mac).then((r)=>device_info());
  }
});

device_info();
</script>
</body>
</html>
