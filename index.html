<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<title>Captive Portal</title>
<link href="/css/portal.css" rel="stylesheet">
</head>
<body>
<div class="main">
  <h1 id="title">CAPTIVE PORTAL</h1>
  <p id="wait">waiting for payment</p>
  <p id="mb">0MB</p>
  <button id="insert">Insert Coin</button>
  <br><br>
  <hr>
  <h2 id="conn">DETECTING DEVICE</h2>
  <div>Data Usage: <span id="data">Calculating...</span></div>
  <div>MAC Address: <span id="mac_addr">Identifying...</span></div>
  <div>IP Address: <span id="ip_addr">0.0.0.0</span></div>
  <div><a href="/txn.html">VIEW TRANSACTIONS</a></div>
  <div>Rates: ₱1 = 50MB; ₱5 = 500MB; ₱10 = 1.0GB</div>
  <p>VALID 'TIL CONSUMED. NO EXPIRY.</p>
  <p><a href="https://dhcp.msu.edu/help/randommac.html">Disable Random MAC Address</a></p>
</div>
<audio id="beep" src="/js/sfx/insert_coin.mp3" preload="auto" loop></audio>
<audio id="bump" src="/js/sfx/bump.wav" preload="auto"></audio>
<audio id="coin" src="/js/sfx/coin.wav" preload="auto"></audio>
<script>
const beep = document.getElementById('beep'),
      btn = document.getElementById('insert'),
      mac = document.getElementById('mac_addr'),
      ip = document.getElementById('ip_addr'),
      d = document.getElementById('data'),
      k = document.getElementById('conn'),
      w = document.getElementById('wait'),
      m = document.getElementById('mb');

var topup_always_check = 0, new_coin=0;

btn.addEventListener('click', function() {
  const x = new XMLHttpRequest(),
      txt = btn.innerText.toLowerCase();

  if( txt == 'connect' ) {
    x.addEventListener('readystatechange', () => {
      if(x.readyState==4) {
        btn.innerText='insert coin';
      }
    });

    x.open('GET','/api/connect.php');
    x.send();
  }

  if( txt == 'insert coin' ) {
    btn.innerText='done';

    x.addEventListener('readystatechange', () => {
      if(x.readyState == 1) {
        topup_always_check=1;
        beep.play(); topup_check();
      }

      if(x.readyState == 4) {
        btn.innerText='insert coin';
        beep.pause();

        if(x.status == 401) {
          bump.play(); alert('coinslot is busy');
        }
      }
    });

    x.open('GET','/api/topup.php');
    x.send();
  }

  if( txt == 'done' ) {
    beep.pause();
    btn.innerText='insert coin';

    x.open('GET','/api/topup_cancel.php');
    x.send();
  }
});

function format_mb(size) {
  if( !size ) return 0;

  let base = Math.floor(Math.log(size) / Math.log(1024));
  let tags = ['MB','GB','TB','PB','EB','ZB','YB'];

  return parseFloat(size / Math.pow(1024, base)).toFixed(2) + tags[base];
}

function topup_check() {
  const x = new XMLHttpRequest();

  x.addEventListener('readystatechange', () => {
    if( x.readyState == 4 && x.status == 200 ) {
      let j = JSON.parse(x.responseText);

      w.innerText = `waiting for payment (${j.cd})`;
      w.style.display='block';
      m.innerText = format_mb(j.mb);

      if( j.mb ) { m.style.display='block'; }

      if(j.amt != new_coin) { coin.play(); new_coin=j.amt;}

      if(topup_always_check) setTimeout(topup_check, 1000);
    }
  });

  x.open('GET','/api/topup_checker.php')
  x.send();
}

function data_usage() {
  const x = new XMLHttpRequest();

  x.addEventListener('readystatechange', () => {
    if( x.readyState == 4 && x.status == 200) {
      let j = JSON.parse(x.responseText);

      
      d.innerText = `${format_mb(j.mb_used)}/${format_mb(j.mb_limit)}`;
      mac.innerText = j.mac;
      ip.innerText = j.ip;

      if( j.mb_limit > j.mb_used &&  k.innerText.toLowerCase() == 'disconnected' ) {
        btn.innerText = 'connect';
      }

      setTimeout(data_usage,30000);
    }
  });

  x.open('GET','/api/data_usage.php');
  x.send();
}

function connection_status() {
  const x = new XMLHttpRequest();

  x.addEventListener('readystatechange', () => {
    if( x.readyState == 4 && x.status == 200 ) {
      parseInt(x.responseText) ? k.innerText = 'connected' : k.innerText = 'disconnected';

      setTimeout(connection_status, 10000);
    }
  });

  x.open('GET','/api/connection_status.php');
  x.send();
}

function button_check() {
  let txt = btn.innerText.toLowerCase();

  if( txt === 'insert coin' ) {
    btn.style.borderColor = '#11aa11';
    btn.style.backgroundColor = '#22aa22';
    m.style.display='none';
    w.style.display='none';
    topup_always_check=0;
  }

  if( txt === 'done' ) {
    btn.style.borderColor = '#aa1111';
    btn.style.backgroundColor = '#aa2222';
  }

  if( txt === 'connect' ) {
    btn.style.borderColor = '#FFB300';
    btn.style.backgroundColor = '#ECA809';
    m.style.display='none';
    w.style.display='none';
    topup_always_check=0;
  }

  setTimeout(button_check,100);
}

function alert(txt) {
  let d = document.createElement('div');
  d.style.backgroundColor='red';
  d.style.textAlign='center';
  d.style.position='fixed';
  d.style.padding='5px';
  d.style.color='white';
  d.style.bottom='0px';
  d.style.right='0px';
  d.style.left='0px';
  d.innerHTML=txt;

  document.body.appendChild(d);

  setTimeout(()=>{d.remove()},5000);
}

button_check(); connection_status(); data_usage();
</script>
</body>
</html>
