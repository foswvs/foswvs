<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<title>PisoWiFi</title>
<link href="/css/portal.css" rel="stylesheet">
</head>
<body>
<div class="main">
  <h1 id="title">piso wifi</h1>
  <p id="slogan">1 5 10</p>
  <p id="wait">waiting for payment</p>
  <p id="mb">0MB</p>
  <button id="insert">Insert Coin</button>
  <br><br>
  <hr>
  <h2 id="conn" style="font-size:14px;">CHECKING NETWORK STATUS</h2>
  <div>Data Usage: <span id="mb_used">0</span>/<span id="mb_limit">0</span><span id="mb_free" style="display:none;">&nbsp;</span></div>
  <div>MAC Address: <span id="mac_addr">Identifying...</span></div>
  <div>IP Address: <span id="ip_addr">0.0.0.0</span></div>
  <div><a href="/txn.html">VIEW TRANSACTIONS</a></div>
  <div>&#x20B1;1.00 = 30MB; &#x20B1;5.00 = 350MB<br>&#x20B1;10.00 = 1GB; &#x20B1;30.00 = 4GB</div>
  <p>VALID 'TIL CONSUMED. NO EXPIRY.</p>
</div>
<audio id="beep" src="/js/sfx/beep.mp3" preload="auto" loop></audio>
<audio id="bump" src="/js/sfx/bump.wav" preload="auto" loop></audio>
<audio id="coin" src="/js/sfx/coin.wav" preload="auto" loop></audio>
<audio id="yeeh" src="/js/sfx/yeeh.mp3" preload="auto" loop></audio>
<script>
const beep = document.getElementById('beep'),
      bump = document.getElementById('bump'),
      coin = document.getElementById('coin'),
       btn = document.getElementById('insert'),
       mac = document.getElementById('mac_addr'),
        ip = document.getElementById('ip_addr'),
         f = document.getElementById('mb_free'),
         u = document.getElementById('mb_used'),
         l = document.getElementById('mb_limit'),
         k = document.getElementById('conn'),
         w = document.getElementById('wait'),
         m = document.getElementById('mb');

var new_coin=0, mb_free=0;

btn.addEventListener('click', function() {
  const x = new XMLHttpRequest(),
      txt = btn.innerText.toLowerCase();

  if( txt == 'connect' ) {
    x.addEventListener('readystatechange', () => {
      if(x.readyState==4) {
        btn.innerText='insert coin';

        if( x.responseText === 'connected' ) {
          k.innerText='connected';
        }
      }
    });

    x.open('GET','/api/connect.php');
    x.send();
  }

  if( txt == 'insert coin' ) {
    btn.innerText='... ... ...';

    x.addEventListener('readystatechange', () => {
      if(x.readyState == 1) {
        setTimeout(topup_check,600);
      }

      if(x.readyState == 4) {
        if(x.status == 200) {
          if(k.innerText.toLowerCase() === 'connected') {
            yeeh.play(); setTimeout(()=>yeeh.pause(),600);
          }
        }

        if(x.status == 401) {
          bump.play(); setTimeout(()=>bump.pause(),600);
          alert('coinslot is busy');
        }
      }
    });

    x.open('GET','/api/topup.php');
    x.send();
  }

  if( txt == 'done' ) {
    beep.pause();
    btn.innerText='insert coin';

    x.open('GET','/api/topup_cancel.php');
    x.send();
  }
});

function format_mb(size) {
  size = parseFloat(size);

  if(!size || size<1) return '0MB';

  let base = Math.floor(Math.log(size) / Math.log(1024));
  let unit = ['MB','GB','TB','PB','EB','ZB','YB'];

  size = size / Math.pow(1024, base);
  size = Number.isInteger(size) ? size : size.toFixed(2);

  return size + unit[base];
}

function topup_check() {
  const x = new XMLHttpRequest();

  x.addEventListener('readystatechange', () => {
    if( x.readyState == 4 ) {
      if( x.status == 200 ) {
        let j = JSON.parse(x.responseText);

        w.innerText = `waiting for payment (${j.cd})`;
        m.innerText = format_mb(j.mb);
        w.style.display='block';
        btn.innerText='done';

        if( j.mb ) { m.style.display='block'; }

        if(j.amt != new_coin) {
          beep.pause(); coin.play();
          data_usage(); new_coin=j.amt;
          setTimeout(()=>coin.pause(),600);
        }
        else { if(beep.paused) beep.play(); }

        setTimeout(topup_check, 1000);
      }

      if( x.status == 401 ) {
        if( !beep.paused ) { beep.pause(); }

        btn.innerText='insert coin'; data_usage();
      }
    }
  });

  x.open('GET','/api/topup_checker.php');
  x.send();
}

function data_usage() {
  const x = new XMLHttpRequest();

  x.addEventListener('readystatechange', () => {
    if( x.readyState == 4 ) {
      if(x.status == 200) {
        let j = JSON.parse(x.responseText);
        mb_free = j.mb_limit - j.mb_used;
      
        u.innerText=format_mb(j.mb_used);
        l.innerText=format_mb(j.mb_limit);

        if (j.mb_used>1) {
          f.innerText = `(${format_mb(mb_free)})`;
          /*f.style.display = mb_free>1 ? 'inline-block' : 'none';*/
        }

        mac.innerText = j.mac;
        ip.innerText = j.ip;
      }

      if( x.status == 401 ) {
        window.location.assign('/u.html');
      }
    }
  });

  x.open('GET','/api/data_usage.php');
  x.send();
}

function connection_status() {
  const x = new XMLHttpRequest();

  x.addEventListener('readystatechange', () => {
    if( x.readyState == 4 ) {
      k.style.fontSize='28px';
      if( x.status === 200 ) {
        k.innerText = 'connected';
      }
      if( x.status === 403 ) {
        k.innerText = 'disconnected';
      }
      if( x.status === 503 ) {
        k.innerText = 'no internet';
      }

      setTimeout(connection_status, 10000);
    }
  });

  x.open('GET','/api/network_status.php');
  x.send();
}

function button_check() {
  let txt = btn.innerText.toLowerCase();

  if( txt === 'insert coin' ) {
    btn.style.borderColor = '#11aa11';
    btn.style.backgroundColor = '#22aa22';
    m.style.display='none';
    w.style.display='none';
  }

  if( txt === 'done' ) {
    btn.style.borderColor = '#aa1111';
    btn.style.backgroundColor = '#aa2222';
  }

  if( k.innerText.toLowerCase() === 'disconnected' &&  mb_free > 0 ) {
    btn.innerText = 'connect';
  }

  if( txt === 'connect' ) {
    btn.style.borderColor = '#FFB300';
    btn.style.backgroundColor = '#ECA809';
    m.style.display='none';
    w.style.display='none';
  }

  setTimeout(button_check,100);
}

function alert(txt) {
  let d = document.createElement('div');
  d.style.backgroundColor='red';
  d.style.textAlign='center';
  d.style.position='fixed';
  d.style.padding='5px';
  d.style.color='white';
  d.style.bottom='0px';
  d.style.right='0px';
  d.style.left='0px';
  d.innerHTML=txt;

  document.body.appendChild(d);

  setTimeout(()=>d.remove(),3000);
}

topup_check(); connection_status(); button_check();
</script>
</body>
</html>
